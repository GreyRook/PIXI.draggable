/**
* The MIT License (MIT)
*
* Copyright (c) 2014 Sebastian Nette
*
* Permission is hereby granted, free of charge, to any person obtaining a copy
* of this software and associated documentation files (the "Software"), to deal
* in the Software without restriction, including without limitation the rights
* to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
* copies of the Software, and to permit persons to whom the Software is
* furnished to do so, subject to the following conditions:
*
* The above copyright notice and this permission notice shall be included in
* all copies or substantial portions of the Software.
*
* THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
* IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
* FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
* AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
* LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
* OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
* THE SOFTWARE.
*
* 
*
*/

/**
 * PIXI Draggables & Droppables v1.0.0
 * Copyright (c) 2014, Sebastian Nette
 * http://www.mokgames.com/
 */

PIXI.DisplayObject.prototype.draggable=function(t,e){if(void 0==e&&null===t)this.__draggable=!1,this.mousedown=this.touchstart=n.mousedown,this.mousemove=this.touchmove=n.mousemove,this.mouseup=this.touchend=n.mouseup,this.mouseupoutside=this.touchendoutside=n.mouseupoutside,this.interactive=!0
else if(void 0===e){this.__draggable&&this.draggable(null)
var n=t||{}
for(var r in PIXI.DragAndDropManager.options.drag)n.hasOwnProperty(r)||(n[r]=PIXI.DragAndDropManager.options.drag[r])
this.mousedown&&!n.mousedown&&(n.mousedown=this.mousedown),this.mousemove&&!n.mousemove&&(n.mousemove=this.mousemove),this.mouseup&&!n.mouseup&&(n.mouseup=this.mouseup),this.mouseupoutside&&!n.mouseupoutside&&(n.mouseupoutside=this.mouseupoutside),this.dragOptions=n,this.offset=new PIXI.Point(0,0),this.original=new PIXI.Point(0,0),n.snap&&(this.snapElements=[]),this.interactive=!0,this.__draggable=!0,this.mousedown=this.touchstart=PIXI.DragAndDropManager.onMouseDown.bind(this),this.mousemove=this.touchmove=PIXI.DragAndDropManager.onMouseMove.bind(this),this.mouseup=this.touchend=PIXI.DragAndDropManager.onMouseUp.bind(this),this.mouseupoutside=this.touchendoutside=PIXI.DragAndDropManager.onMouseUpOutside.bind(this)}else this.dragOptions&&(this.dragOptions[t]=e,"snap"===t&&e&&(this.snapElements=[]))
return this},PIXI.DisplayObject.prototype.droppable=function(t,e){if(void 0==e&&null===t)this.__droppable=!1,this.interactive=!0
else if(void 0===e){var n=t||{}
for(var r in PIXI.DragAndDropManager.options.drop)n.hasOwnProperty(r)||(n[r]=PIXI.DragAndDropManager.options.drop[r])
this.dropOptions=n,this.interactive=!0,this.__droppable=!0}else this.dropOptions&&(this.dropOptions[t]=e)
return this},PIXI.DragAndDropManager=function(){this.draggableItems=[],this.droppableItems=[],this.tweeningItems=[],this.boundTick=this.tick.bind(this),this.isTicking=!1},PIXI.DragAndDropManager.prototype.constructor=PIXI.DragAndDropManager,PIXI.DragAndDropManager.prototype.clear=function(){this.draggableItems.length=0,this.droppableItems.length=0},PIXI.DragAndDropManager.prototype.collect=function(t){t.__draggable&&this.draggableItems.push(t),t.__droppable&&this.droppableItems.push(t)},PIXI.DragAndDropManager.prototype.onDrag=function(t,e){var n=t.dragOptions
if(t.tweening||n.disabled)return void(t.__isDragging=!1)
var r,a
if(n.handle)if("string"==typeof n.handle){var i=!1
for(r=t.children.length;r>=0;r--)if(a=t.children[r],(a.label===n.handle||a.__draggable&&a.dragOptions.label===n.handle||a.__droppable&&a.dropOptions.label===n.handle)&&t.stage.interactionManager.hitTest(a,e)){i=!0
break}if(!i)return void(t.__isDragging=!1)}else if(!t.stage.interactionManager.hitTest(n.handle,e))return void(t.__isDragging=!1)
if(n.cancel)if("string"==typeof n.cancel){for(r=t.children.length;r>=0;r--)if(a=t.children[r],(a.label===n.cancel||a.__draggable&&a.dragOptions.label===n.cancel||a.__droppable&&a.dropOptions.label===n.cancel)&&t.stage.interactionManager.hitTest(a,e))return void(t.__isDragging=!1)
if(!i)return void(t.__isDragging=!1)}else if(t.stage.interactionManager.hitTest(n.cancel,e))return void(t.__isDragging=!1)
if(n.cursorAt){var o=e.getLocalPosition(t)
t.offset.set(n.cursorAt[0]-o.x,n.cursorAt[1]-o.y)}else t.offset.set(0,0)
t.original.x=t.x,t.original.y=t.y,e.start?(e.start.x=e.global.x,e.start.y=e.global.y):e.start=e.global.clone(),t.originalAlpha=t.alpha},PIXI.DragAndDropManager.prototype.onDragStart=function(t,e){var n=t.dragOptions
if(Math.abs(e.start.x-e.global.x)<n.distance&&Math.abs(e.start.y-e.global.y)<n.distance)return void(t.__dragStart=!1)
if(this.destroyHelperSprite(t),"clone"===n.helper?(t.dragElement=new PIXI.Sprite(t.generateTexture()),t.parent.addChild(t.dragElement),t.dragElement.position.set(t.x,t.y),t.dragElement.pivot.set(t.pivot.x,t.pivot.y),t.anchor&&t.dragElement.anchor.set(t.anchor.x,t.anchor.y),"inherit"!==n.cursor&&(t.dragElement.interactive=!0)):t.dragElement=t,t.dragElement._defaultCursor=t.dragElement.defaultCursor,t.dragElement.defaultCursor=n.cursor,t.dragElement._buttonMode=t.dragElement.buttonMode,t.dragElement.buttonMode=!0,t.dragElement.alpha=t.alpha*n.alpha,n.snap)for(var r,a,i=this.draggableItems,o=i.length-1;o>=0;o--)r=i[o],!r.worldVisible||n.snap!==!0&&n.snap!==r.dragOptions.label||r===t||(a=r.hitArea?r.hitArea:r.getBounds(),r.snapBounds?(r.snapBounds.x=a.x,r.snapBounds.y=a.y,r.snapBounds.x2=a.x+a.width,r.snapBounds.y2=a.y+a.height):r.snapBounds={x:a.x,y:a.y,x2:a.x+a.width,y2:a.y+a.height,dist:0},t.snapElements.push(r))
n.start&&n.start(t,e)},PIXI.DragAndDropManager.prototype.onDragMove=function(){function t(t){return t*t}return function(e,n){var r,a,i=e.dragOptions,o=n.global.x,s=n.global.y,g=o-n.start.x,d=s-n.start.y,l=e.original.x+g-e.offset.x,p=e.original.y+d-e.offset.y,h=l+e.width,u=p+e.height
if(i.containment&&(r="parent"===i.containment?e.parent.getBounds():i.containment instanceof PIXI.Rectangle?i.containment:i.containment.getBounds(),"y"!==i.axis&&(0>l?l=0:h>r.width&&(l=r.width-e.width)),"x"!==i.axis&&(0>p?p=0:u>r.height&&(p=r.height-e.height))),i.grid){var m
i.grid[0]&&"y"!==i.axis&&(m=i.grid[0],l=e.original.x+Math.round((l-e.original.x)/m)*m,r&&!(l>0||h<r.width)&&(l+=l>0?-m:m)),i.grid[1]&&"x"!==i.axis&&(m=i.grid[1],p=e.original.y+Math.round((p-e.original.y)/m)*m,r&&!(p>0||u<r.height)&&(p+=p>0?-m:m))}if(i.snap){var c,D,y,I,f,a,M=!1,x=i.snapTolerance
if(i.snapSort){var b=e.worldTransform.tx+e.width/2,v=e.worldTransform.ty+e.height/2
for(a=e.snapElements.length-1;a>=0;a--)c=e.snapElements[a],c.snapBounds.dist=t(b-c.worldTransform.tx-c.width/2)+t(v-c.worldTransform.ty-c.height/2,2)
e.snapElements.sort(this.closestSort)}for(a=e.snapElements.length-1;!M&&a>=0;a--)c=e.snapElements[a],D=c.snapBounds.x,y=c.snapBounds.x2,I=c.snapBounds.y,f=c.snapBounds.y2,h>D-x&&y+x>l&&u>I-x&&f+x>p&&("inner"!==i.snapMode&&(Math.abs(I-u)<=x?(p=I-e.height,M=!0):Math.abs(f-p)<=x&&(p=f,M=!0),Math.abs(D-h)<=x?(l=D-e.width,M=!0):Math.abs(y-l)<=x&&(l=y,M=!0)),M||"outer"===i.snapMode||(Math.abs(I-p)<=x?(p=I,M=!0):Math.abs(f-u)<=x&&(p=f-e.height,M=!0),Math.abs(D-l)<=x?(l=D,M=!0):Math.abs(y-h)<=x&&(l=y-e.width,M=!0)))}"x"===i.axis?e.dragElement.x=l:"y"===i.axis?e.dragElement.y=p:(e.dragElement.x=l,e.dragElement.y=p),i.drag&&i.drag(e,n)}}(),PIXI.DragAndDropManager.prototype.onDrop=function(t,e){var n=t.dragOptions
t.dragElement.defaultCursor=t.dragElement._defaultCursor,t.dragElement.buttonMode=t.dragElement._buttonMode
var r=this.droppableItems,a=!1
if(r.length){var i,o,s,g,d=[],l=t.dragElement.getBounds()
for(l.x2=l.x+l.width,l.y2=l.y+l.height,s=r.length-1;s>=0;s--)if(i=r[s],i.worldVisible&&i!==t&&!i.dropOptions.disabled)if(o=i.dropOptions.accept,o instanceof Array){for(g=o.length-1;g>=0;g--)if((o[g]===this||o[g]===n.label)&&this.intersect(t,e,i,l)){if(a=!0,i.dropOptions.greedy){d.length=0,d.push(i),s=-1
break}d.push(i)}}else if((o===this||o===n.label||o===!0)&&this.intersect(t,e,i,l)){if(a=!0,i.dropOptions.greedy){d.length=0,d.push(i)
break}d.push(i)}for(s=d.length-1;s>=0;s--)d[s].dropOptions.drop&&d[s].dropOptions.drop(t,e)}else a=!0
"invalid"===n.revert&&!a||"valid"===n.revert&&a||n.revert===!0?n.revertDuration?(t.tweening=!0,this.tweeningItems.push({time:Date.now(),duration:n.revertDuration,item:t,mouse:e,x:t.dragElement.x,y:t.dragElement.y,dx:t.dragElement.x-t.original.x,dy:t.dragElement.y-t.original.y}),this.isTicking||(this.isTicking=!0,this.tick())):(t.dragElement.x=t.original.x,t.dragElement.y=t.original.y,this.stop(t,e)):(t.dragElement!==t&&(t.x=t.dragElement.x,t.y=t.dragElement.y),this.stop(t,e))},PIXI.DragAndDropManager.prototype.tick=function(){var t=this.tweeningItems.length
if(!t)return void(this.isTicking=!1)
requestAnimationFrame(this.boundTick)
for(var e,n,r,a=Date.now(),i=t-1;i>=0;i--)e=this.tweeningItems[i],n=a-e.time,r=e.item,n>=e.duration?(r.tweening=!1,r.dragElement.x=r.original.x,r.dragElement.y=r.original.y,this.stop(r,e.mouse),this.tweeningItems.splice(i,1)):(r.dragElement.x=e.x-e.dx*n/e.duration,r.dragElement.y=e.y-e.dy*n/e.duration)},PIXI.DragAndDropManager.prototype.stop=function(t,e){t.dragElement.alpha=t.originalAlpha,this.destroyHelperSprite(t),t.dragOptions.snap&&(t.snapElements.length=0),t.dragOptions.stop&&t.dragOptions.stop(t,e)},PIXI.DragAndDropManager.prototype.closestSort=function(t,e){return t.snapBounds.snapDist<e.snapBounds.snapDist?-1:t.snapBounds.snapDist>e.snapBounds.snapDist?1:0},PIXI.DragAndDropManager.prototype.destroyHelperSprite=function(t){t.dragElement&&t.dragElement!==t&&(t.dragElement.parent.removeChild(t.dragElement),t.dragElement.texture.destroy(!0),t.dragElement=null)},PIXI.DragAndDropManager.prototype.intersect=function(t,e,n,r){var a
switch(n.dropOptions.tolerance){case"intersect":return a=n.getBounds(),a.x<r.x+r.width/2&&r.x2-r.width/2<a.x+a.width&&a.y<r.y+r.height/2&&r.y2-r.height/2<a.y+a.height
case"fit":return a=n.getBounds(),a.x<=r.x&&r.x2<=a.x+a.width&&a.y<=r.y&&r.y2<=a.y+a.height
case"pointer":return t.stage.interactionManager.hitTest(n,e)
case"touch":return a=n.getBounds(),(r.y>=a.y&&r.y<=a.y+a.height||r.y2>=a.y&&r.y2<=a.y+a.height||r.y<a.y&&r.y2>a.y+a.height)&&(r.x>=a.x&&r.x<=a.x+a.width||r.x2>=a.x&&r.x2<=a.x+a.width||r.x<a.x&&r.x2>a.x+a.width)
default:return!1}},PIXI.DragAndDropManager.onMouseDown=function(t){this.dragOptions.mousedown&&this.dragOptions.mousedown(t),this.__isDragging=!0,this.stage.interactionManager.DragAndDropManager.onDrag(this,t)},PIXI.DragAndDropManager.onMouseMove=function(t){this.dragOptions.mousemove&&this.dragOptions.mousemove(t),this.__isDragging&&(this.__dragStart?this.stage.interactionManager.DragAndDropManager.onDragMove(this,t):(this.__dragStart=!0,this.stage.interactionManager.DragAndDropManager.onDragStart(this,t)))},PIXI.DragAndDropManager.onMouseUp=function(t){this.dragOptions.mouseup&&this.dragOptions.mouseup(t),this.__isDragging&&(this.__isDragging=!1,this.__dragStart&&(this.__dragStart=!1,this.stage.interactionManager.DragAndDropManager.onDrop(this,t)))},PIXI.DragAndDropManager.onMouseUpOutside=function(t){this.dragOptions.mouseupoutside&&this.dragOptions.mouseupoutside(t),this.__isDragging&&(this.__isDragging=!1,this.__dragStart&&(this.__dragStart=!1,this.stage.interactionManager.DragAndDropManager.onDrop(this,t)))},PIXI.DragAndDropManager.options={drag:{distance:1,axis:null,containment:null,cursor:"inherit",cursorAt:null,grid:!1,handle:null,cancel:null,helper:"original",alpha:1,revert:!1,revertDuration:500,label:null,snap:null,snapMode:"both",snapSort:!1,snapTolerance:20,disabled:!1,drag:null,start:null,stop:null,mousedown:null,mousemove:null,mouseup:null,mouseupoutside:null},drop:{label:null,drop:null,accept:!0,greedy:!1,disabled:!1,tolerance:"intersect"}},PIXI.InteractionManager.prototype.rebuildInteractiveGraph=function(){var t=PIXI.InteractionManager.prototype.rebuildInteractiveGraph
return function(){this.DragAndDropManager?this.DragAndDropManager.clear():this.DragAndDropManager=new PIXI.DragAndDropManager,t.call(this)
for(var e=this.interactiveItems.length-1;e>=0;e--)this.DragAndDropManager.collect(this.interactiveItems[e])}}()
